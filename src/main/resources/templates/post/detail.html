<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8">
		<title>게시글상세</title>
	</head>
	<body>
		게시글 상세보기
		<p th:text="${post.writer}"></p>
		<p th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></p>
		<p th:text="${post.title}"></p>
		<p th:text="${post.content}"></p>

		<button type="button"  th:onclick="|onClickUpdate(${post.id})|">글 수정</button>
		<button type="button" th:onclick="|onClickDelete(${post.id})|">글 삭제</button>

		<section>
			<p>댓글</p>
			<ul th:if="${comments != null and comments.size() > 0}">
				<li th:each="comment : ${comments}">
					<span th:text="${comment.writer}"></span>
					<span th:text="${comment.content}"></span>
					<span th:text="${comment.createdAt}"></span>

					<!-- 대댓글 토글 버튼 -->
					<button type="button" th:attr="onclick=|toggleReplyForm(${comment.id})|">대댓글</button>
					<!-- 대댓글 입력 폼 (기본 숨김) -->
<!--					<div th:attr="id='reply-form-' + ${comment.id}" style="display: none; margin-top: 8px;">-->
						<form th:action="@{/post/{postId}/comment(postId=${post.id})}" method="post">
							<input type="hidden" name="parent.id" th:value="${comment.id}" />
							<textarea name="content" placeholder="답글을 입력하세요" required></textarea>
							<button type="submit">답글 등록</button>
						</form>
<!--					</div>-->
					<ul>
						<li th:each="reply : ${comment.replies}">
							<span th:text="${reply.writer}"></span>
							<span th:text="${reply.content}"></span>
							<span th:text="${reply.createdAt}"></span>
						</li>
					</ul>
				</li>
			</ul>
			<form th:action="@{/post/{postId}/comment(postId=${post.id})}" method="post">
				<input type="text" name="writer" placeholder="작성자" required />
				<input type="text" name="content" placeholder="댓글을 입력하세요" required />
				<button type="submit">등록</button>
			</form>
		</section>
		<script>

			function onClickUpdate(postId) {
				submitCheckPassword(postId, "edit");
			}

			function onClickDelete(postId) {
				submitCheckPassword(postId, "delete");
			}

			function submitCheckPassword(postId, action) {
				const password = prompt("비밀번호를 입력해주세요.");
				if(password === null) return false;
				const form = document.createElement("form");
				form.method="POST";
				form.action = `/posts/${postId}/check-password`;

				const pw = document.createElement("input");
				pw.type = "hidden";
				pw.name = "password";
				pw.value = password;

				const act = document.createElement("input");
				act.type = "hidden";
				act.name = "action";
				act.value = action;

				form.appendChild(pw);
				form.appendChild(act);
				document.body.appendChild(form);
				form.submit();
			}

		</script>
	</body>
</html>